<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì˜¬í•´ì˜ ê²°ì‚° ë„ìš°ë¯¸</title>

  <style>
    :root{
      /* ğŸ„ Default Theme (Red/White) */
      --bg:#fff6f7;
      --card:#ffffff;

      --text:#1b1b1b;
      --muted:#5d5d5d;

      --line:rgba(0,0,0,.08);

      --accent:#d12b2b;
      --accent2:#ff4a4a;

      --danger:#d12b2b;
      --ok:#0c8f47;

      --shadow: 0 16px 50px rgba(0,0,0,.08);
      --r: 18px;
      --pad: 18px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
        "Noto Sans KR", AppleSDGothicNeo, "Malgun Gothic", Arial, sans-serif;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:24px 14px 60px;

      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240' viewBox='0 0 240 240'%3E%3Crect width='240' height='240' fill='none'/%3E%3Cg fill='%23ffffff' fill-opacity='0.9'%3E%3Ccircle cx='30' cy='40' r='2'/%3E%3Ccircle cx='80' cy='90' r='1.8'/%3E%3Ccircle cx='140' cy='60' r='2.2'/%3E%3Ccircle cx='200' cy='110' r='1.6'/%3E%3Ccircle cx='50' cy='160' r='2'/%3E%3Ccircle cx='120' cy='170' r='1.6'/%3E%3Ccircle cx='210' cy='190' r='2.2'/%3E%3C/g%3E%3C/svg%3E"),
        linear-gradient(180deg, var(--bg) 0%, #ffeef0 100%);

      background-repeat: repeat, no-repeat;
      background-size: 240px 240px, cover;
      background-attachment: fixed;
    }

    .wrap{ width:min(980px, 100%); }

    .screen{
      transition: opacity .45s ease, transform .45s ease;
      will-change: opacity, transform;
    }
    .hidden{
      opacity:0;
      transform: translateY(8px);
      pointer-events:none;
      position:absolute;
      inset:0;
    }
    .visible{
      opacity:1;
      transform: translateY(0);
      position:relative;
    }

    .start-card{
      width:min(760px, 100%);
      margin: 10px auto 0;
      background:rgba(255,255,255,.90);
      border:1px solid var(--line);
      border-radius:24px;
      box-shadow:var(--shadow);
      padding:26px 22px;
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }
    .start-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.85);
      color:var(--muted);
      font-weight:800;
      font-size:12px;
    }
    .start-title{
      margin:14px 0 10px;
      font-size:28px;
      font-weight:1000;
      letter-spacing:-.6px;
      line-height:1.2;
    }
    .start-sub{
      margin:0 0 18px;
      color:var(--muted);
      line-height:1.6;
      font-size:14px;
    }
    .start-cta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .start-note{
      margin-top:12px;
      color:rgba(93,93,93,.85);
      font-size:12px;
      line-height:1.6;
    }
    .start-deco{
      position:absolute;
      top:-110px;
      right:-110px;
      width:260px;
      height:260px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,74,74,.25), rgba(209,43,43,.18) 35%, transparent 70%);
      filter: blur(0px);
    }

    header{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:18px;
    }

    .brand{ display:flex; flex-direction:column; gap:6px; }

    .title{
      font-size:22px;
      font-weight:900;
      letter-spacing:-.2px;
      margin:0;
    }

    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(255,255,255,.8);
      color:var(--muted);
      font-size:12px;
      user-select:none;
      backdrop-filter: blur(6px);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
    }
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }

    .card{
      background:rgba(255,255,255,.9);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(8px);
    }

    .card .head{
      padding:16px var(--pad);
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .card .head h2{
      margin:0;
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:-.1px;
    }

    .card .body{ padding:18px var(--pad); }

    .progress{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }

    .bar{
      flex:1;
      height:10px;
      background:rgba(0,0,0,.06);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.06);
    }

    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius:999px;
      transition:width .35s ease;
    }

    .pct{
      font-size:12px;
      color:var(--muted);
      min-width:86px;
      text-align:right;
    }

    .qbox{
      padding:16px;
      border-radius:14px;
      border:1px solid var(--line);
      background:
        radial-gradient(400px 120px at 20% 20%, rgba(209,43,43,.10), transparent 60%),
        radial-gradient(420px 140px at 80% 30%, rgba(255,74,74,.08), transparent 60%),
        rgba(255,255,255,.75);
      margin-bottom:12px;
    }

    .qnum{ color:var(--muted); font-size:12px; margin-bottom:6px; }

    .qtext{
      margin:0;
      font-size:18px;
      font-weight:900;
      letter-spacing:-.3px;
      line-height:1.35;
    }

    textarea{
      width:100%;
      min-height:110px;
      resize:vertical;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.92);
      color:var(--text);
      outline:none;
      font-size:14px;
      line-height:1.6;
    }

    textarea:focus{
      border-color:rgba(209,43,43,.45);
      box-shadow: 0 0 0 3px rgba(209,43,43,.14);
    }

    .hint{
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }

    button{
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.92);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      transition: transform .05s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
      user-select:none;
    }

    button:hover{
      background:#ffffff;
      border-color:rgba(0,0,0,.16);
    }

    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.45; cursor:not-allowed; }

    .primary{
      color:white;
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      border-color:rgba(209,43,43,.25);
    }

    .primary:hover{ filter:brightness(1.03); }

    .danger{
      color:white;
      background:linear-gradient(90deg, #b51f1f, var(--accent2));
      border-color:rgba(209,43,43,.25);
    }

    .danger:hover{ filter:brightness(1.03); }

    .ghost{
      background:transparent;
      border-color:rgba(0,0,0,.10);
    }

    .ghost:hover{ background:rgba(255,255,255,.75); }

    .side-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:520px;
      overflow:auto;
      padding-right:6px;
    }

    .item{
      border:1px solid var(--line);
      background:rgba(255,255,255,.85);
      border-radius:14px;
      padding:12px;
    }

    .item .meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:6px;
    }

    .item .meta b{ font-size:12px; color:var(--muted); }

    .tag{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      color:var(--muted);
      background:rgba(255,255,255,.9);
      white-space:nowrap;
    }

    .ans{
      margin:0;
      font-size:13px;
      line-height:1.55;
      color:#222;
      white-space:pre-wrap;
      word-break:break-word;
    }

    .empty{ color:rgba(93,93,93,.75); font-style:italic; }

    .editlink{
      margin-top:8px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      font-weight:900;
      color: var(--accent);
      background: rgba(209,43,43,.06);
      border:1px solid rgba(209,43,43,.12);
      padding:7px 10px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
    }
    .editlink:hover{ filter:brightness(1.02); }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(255,255,255,.95);
      border:1px solid rgba(0,0,0,.12);
      box-shadow:var(--shadow);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      display:none;
      gap:10px;
      align-items:center;
      z-index:50;
      max-width:min(720px, 92vw);
    }

    .dot{
      width:9px;
      height:9px;
      border-radius:50%;
      background:var(--ok);
      box-shadow:0 0 0 3px rgba(12,143,71,.12);
      flex:0 0 auto;
    }

    .footer-tools{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }
    .small{ font-size:12px; color:var(--muted); line-height:1.6; margin:0; }

    details{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.85);
      padding:10px 12px;
      margin-top:12px;
    }

    summary{
      cursor:pointer;
      color:var(--muted);
      font-weight:900;
      font-size:13px;
      list-style:none;
    }
    summary::-webkit-details-marker{display:none}

    .qedit{ margin-top:10px; }
    .qedit textarea{ min-height:160px; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }

    .row input{
      flex:1;
      min-width:240px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.92);
      color:var(--text);
      outline:none;
      font-size:13px;
    }

    .row input:focus{
      border-color:rgba(209,43,43,.45);
      box-shadow: 0 0 0 3px rgba(209,43,43,.14);
    }

    /* Color pickers */
    .color-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }
    .color-chip{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.92);
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }
    .color-chip input[type="color"]{
      width:44px;
      height:32px;
      border:none;
      background:transparent;
      padding:0;
      cursor:pointer;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- Start Screen -->
    <section id="startScreen" class="screen visible">
      <div class="start-card">
        <div class="start-deco" aria-hidden="true"></div>
        <span class="start-badge">ğŸ ì—°ë§ ê²°ì‚°</span>
        <h1 class="start-title" id="startTitle">2025ë…„ ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤. ì—°ë§ê²°ì‚° ì‹œì‘í•  ì¤€ë¹„ ë˜ì…¨ë‚˜ìš”?</h1>
        <p class="start-sub">
          ì§ˆë¬¸ì´ í•˜ë‚˜ì”© ë‚˜ì™€ìš”. ë‹µí•´ë„ ë˜ê³ , ë¹„ì›Œë‘ê³  ë„˜ì–´ê°€ë„ ë©ë‹ˆë‹¤.<br/>
          ê±±ì •ë§ˆì„¸ìš”! ì‘ì„±í•œ ë‚´ìš©ì€ <b>ë‚´ ë¸Œë¼ìš°ì €ì—ë§Œ</b> ì €ì¥ë¼ìš”.
        </p>
        <div class="start-cta">
          <button class="primary" id="startBtn">ì‹œì‘í•˜ê¸°</button>
          <button class="ghost" id="startResetBtn" title="ì €ì¥ëœ ì§„í–‰ ìƒíƒœë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤">ì €ì¥ëœ ì§„í–‰ ì´ˆê¸°í™”</button>
        </div>
        <p class="start-note">TIP: ì‹œì‘ í›„ ì˜¤ë¥¸ìª½ ëª©ë¡ì—ì„œ ì§ˆë¬¸ì„ ëˆŒëŸ¬ â€œìˆ˜ì •í•˜ê¸°â€ë¡œ ë˜ëŒì•„ê°ˆ ìˆ˜ ìˆì–´ìš”.</p>
      </div>
    </section>

    <!-- App Screen -->
    <section id="appScreen" class="screen hidden">
      <header>
        <div class="brand">
          <h1 class="title">ì˜¬í•´ì˜ ê²°ì‚° ë„ìš°ë¯¸</h1>
          <p class="subtitle">ì§ˆë¬¸ì— ë‹µí•˜ë‹¤ë³´ë©´, ì–´ëŠìƒˆ ì—°ë§ê²°ì‚° ë! (ìˆ˜ì •/ë³µì‚¬/ìŠ¤í† ë¦¬ ì¹´ë“œ ì œì‘)</p>
        </div>
        <div class="pill" id="yearPill">ğŸ <span id="yearText"></span> ì—°ë§ ê²°ì‚°</div>
      </header>

      <div class="grid">
        <!-- Left -->
        <section class="card" id="flowCard">
          <div class="head">
            <h2 id="modeTitle">ì§„í–‰</h2>
            <div class="pill">âŒ¨ï¸ <code>Ctrl</code>+<code>Enter</code> ë‹¤ìŒ</div>
          </div>
          <div class="body">
            <div class="progress">
              <div class="bar"><i id="barFill"></i></div>
              <div class="pct" id="pctText">0% Â· 0/0</div>
            </div>

            <div class="qbox">
              <div class="qnum" id="qNum">Q1</div>
              <p class="qtext" id="qText">ì§ˆë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
            </div>

            <textarea id="answer" placeholder="ì—¬ê¸°ì— ë‹µë³€í•´ì¤˜! (ë¹„ì›Œë‘ê³  ë„˜ì–´ê°€ë„ ê´œì°®ì•„!)"></textarea>
            <div class="hint">
              <span>íŒ: ë‹µì´ ê¸¸ì–´ë„ ê´œì°®ì•„. ì¤„ë°”ê¿ˆ ê·¸ëŒ€ë¡œ ì €ì¥ë¼.</span>
            </div>

            <div class="btns">
              <button class="primary" id="nextBtn">ë‹¤ìŒ</button>
              <button class="danger" id="stopBtn">ì—¬ê¸°ì„œ ë©ˆì¶”ê³  ê²°ì‚° ë³´ê¸°</button>
              <button class="ghost" id="restartBtn" title="ë‹µë³€ì€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤">ì²˜ìŒë¶€í„° ë‹¤ì‹œ</button>
            </div>

            <details>
              <summary>âš™ï¸ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ (ì§ˆë¬¸/ì œëª©/ì»¬ëŸ¬ ë°”ê¾¸ê¸°)</summary>
              <div class="qedit">
                <p class="small">
                  - ì œëª©ì„ ë°”ê¾¸ë©´ í˜ì´ì§€ íƒ€ì´í‹€ë„ í•¨ê»˜ ë°”ë€œ<br/>
                  - ì§ˆë¬¸ì€ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„ (ë¹ˆ ì¤„ ë¬´ì‹œ)<br/>
                  - ì»¬ëŸ¬ë¥¼ ë°”ê¾¸ë©´ UI + ìŠ¤í† ë¦¬ ì¹´ë“œ ìƒ‰ê°ë„ í•¨ê»˜ ë°”ë€œ
                </p>

                <div class="row">
                  <input id="customTitle" placeholder="ì˜ˆ: ì˜¬í•´ì˜ ê¸°ë¡ / ì˜¬í•´ì˜ ê°ì‚¬ / ì˜¬í•´ì˜ ì†Œë¹„" />
                  <button id="applyTitleBtn">ì œëª© ì ìš©</button>
                </div>

                <!-- âœ… Color Custom -->
                <div class="color-row">
                  <div class="color-chip">
                    Primary
                    <input id="colorAccent" type="color" />
                  </div>
                  <div class="color-chip">
                    Secondary
                    <input id="colorAccent2" type="color" />
                  </div>
                  <div class="color-chip">
                    Background
                    <input id="colorBg" type="color" />
                  </div>
                  <button id="resetColorsBtn">ì»¬ëŸ¬ ì´ˆê¸°í™”</button>
                </div>

                <textarea id="questionsEditor"></textarea>
                <div class="row">
                  <button id="applyQuestionsBtn">ì§ˆë¬¸ ì ìš© (ì§„í–‰ ì´ˆê¸°í™”)</button>
                  <button id="resetQuestionsBtn">ê¸°ë³¸ ì§ˆë¬¸ìœ¼ë¡œ ë³µì›</button>
                </div>

                <p class="small">* ì„œë²„ ì—†ì´ ë™ì‘: ì§„í–‰ ìƒíƒœëŠ” ë‚´ ë¸Œë¼ìš°ì €(localStorage)ì—ë§Œ ì €ì¥ë¼.</p>
              </div>
            </details>
          </div>
        </section>

        <!-- Right -->
        <aside class="card" id="summaryCard">
          <div class="head">
            <h2>ì§€ê¸ˆê¹Œì§€ ë‹µë³€</h2>
            <div class="pill">ğŸ§¾ ìˆ˜ì • ê°€ëŠ¥</div>
          </div>
          <div class="body">
            <div class="side-list" id="sideList"></div>

            <div class="footer-tools">
              <button class="primary" id="copyNumberedBtn">ë²ˆí˜¸ ë¦¬ìŠ¤íŠ¸ë¡œ ë³µì‚¬</button>
              <button id="copyAllBtn">ì „ì²´ ë³µì‚¬</button>
              <button class="ghost" id="copyAnsweredOnlyBtn">ë‹µë³€í•œ ê²ƒë§Œ ë³µì‚¬</button>
              <button class="danger" id="exportImageBtn" title="ë‹µë³€ ì¼ë¶€ë¥¼ ê³¨ë¼ 1080x1920 ìŠ¤í† ë¦¬ PNGë¡œ ì €ì¥">ğŸ“¸ ìŠ¤í† ë¦¬ ì¹´ë“œ ì œì‘</button>
              <!-- âœ… Feedback button -->
              <button class="ghost" id="feedbackBtn" title="ê°œë°œìì—ê²Œ í”¼ë“œë°± ë³´ë‚´ê¸°">ğŸ’Œ í”¼ë“œë°± ë³´ë‚´ê¸°</button>
            </div>
            <p class="small">* ì¸ìŠ¤íƒ€ ì¹´ë“œëŠ” 1080Ã—1920(ìŠ¤í† ë¦¬) PNGë¡œ ë‹¤ìš´ë¡œë“œë¼.</p>
          </div>
        </aside>
      </div>
    </section>
  </div>

  <div class="toast" id="toast">
    <span class="dot"></span>
    <span id="toastText">ì™„ë£Œ!</span>
  </div>

<script>
(() => {
  // =============================
  // âœ… ë‚˜ì¤‘ì— ë„ˆê°€ ë§í¬ë§Œ ë°”ê¿” ë¼ìš°ë©´ ë¨
  // =============================
  const FEEDBACK_URL = "https://example.com/your-feedback-form"; // TODO: ì—¬ê¸°ì— êµ¬ê¸€í¼/ë…¸ì…˜í¼ ë§í¬ ë„£ê¸°

  // ====== 30ê°œ ì¶”ì²œ ê¸°ë³¸ ì§ˆë¬¸ ======
  const DEFAULT_QUESTIONS = [
    "ì˜¬í•´ì˜ ì˜í™”ëŠ”?",
    "ì˜¬í•´ì˜ ë“œë¼ë§ˆëŠ”?",
    "ì˜¬í•´ì˜ ë…¸ë˜ëŠ”?",
    "ì˜¬í•´ì˜ ì•¨ë²”ì€?",
    "ì˜¬í•´ì˜ ì±…ì€?",
    "ì˜¬í•´ì˜ ìœ íŠœë¸ŒëŠ”?",
    "ì˜¬í•´ì˜ ì „ì‹œëŠ”?",
    "ì˜¬í•´ì˜ ë¬¸ì¥ì€?",
    "ì˜¬í•´ì˜ ë§ì€?",
    "ì˜¬í•´ì˜ ìƒ‰ê¹”ì€?",
    "ì˜¬í•´ì˜ ì—¬í–‰ì€?",
    "ì˜¬í•´ì˜ ìŒì‹ì€?",
    "ì˜¬í•´ì˜ ë””ì €íŠ¸ëŠ”?",
    "ì˜¬í•´ì˜ ì»¤í”¼ëŠ”?",
    "ì˜¬í•´ì˜ ì‹ë‹¹ì€?",
    "ì˜¬í•´ì˜ ì†Œë¹„ëŠ”?",
    "ì˜¬í•´ì˜ ë“í…œì€?",
    "ì˜¬í•´ì˜ êµ¬ë…ì€?",
    "ì˜¬í•´ì˜ ìš´ë™ì€?",
    "ì˜¬í•´ì˜ ìŠµê´€ì€?",
    "ì˜¬í•´ì˜ ê³µê°„ì€?",
    "ì˜¬í•´ì˜ ì‚°ì±…ë¡œëŠ”?",
    "ì˜¬í•´ì˜ ë§Œë‚¨ì€?",
    "ì˜¬í•´ì˜ ê°ì‚¬ëŠ”?",
    "ì˜¬í•´ì˜ ë‚˜ëˆ”ì€?",
    "ì˜¬í•´ì˜ ì„±ì·¨ëŠ”?",
    "ì˜¬í•´ì˜ ë„ì „ì€?",
    "ì˜¬í•´ì˜ í”„ë¡œì íŠ¸ëŠ”?",
    "ì˜¬í•´ì˜ ê³ ë¯¼ì€?",
    "ì˜¬í•´ì˜ í›„íšŒëŠ”?"
  ];

  const normalizeText = (s) => String(s ?? "").trim().replace(/\s+/g, " ");
  const uniqueQuestions = (arr) => {
    const seen = new Set();
    const out = [];
    for(const q of arr){
      const nq = normalizeText(q);
      if(!nq) continue;
      if(seen.has(nq)) continue;
      seen.add(nq);
      out.push(nq);
    }
    return out;
  };

  // ====== LocalStorage Keys ======
  const LS_KEY = "year_review_helper_redwhite_v3";
  const LS_THEME_KEY = "year_review_theme_v1";

  // ====== DOM ======
  const startScreen = document.getElementById("startScreen");
  const appScreen = document.getElementById("appScreen");
  const startBtn = document.getElementById("startBtn");
  const startResetBtn = document.getElementById("startResetBtn");

  const yearText = document.getElementById("yearText");
  const modeTitle = document.getElementById("modeTitle");
  const barFill = document.getElementById("barFill");
  const pctText = document.getElementById("pctText");
  const qNum = document.getElementById("qNum");
  const qText = document.getElementById("qText");
  const answerEl = document.getElementById("answer");
  const sideList = document.getElementById("sideList");

  const nextBtn = document.getElementById("nextBtn");
  const stopBtn = document.getElementById("stopBtn");
  const restartBtn = document.getElementById("restartBtn");

  const copyAllBtn = document.getElementById("copyAllBtn");
  const copyNumberedBtn = document.getElementById("copyNumberedBtn");
  const copyAnsweredOnlyBtn = document.getElementById("copyAnsweredOnlyBtn");
  const exportImageBtn = document.getElementById("exportImageBtn");
  const feedbackBtn = document.getElementById("feedbackBtn");

  const toast = document.getElementById("toast");
  const toastText = document.getElementById("toastText");

  const customTitle = document.getElementById("customTitle");
  const applyTitleBtn = document.getElementById("applyTitleBtn");
  const questionsEditor = document.getElementById("questionsEditor");
  const applyQuestionsBtn = document.getElementById("applyQuestionsBtn");
  const resetQuestionsBtn = document.getElementById("resetQuestionsBtn");

  // Theme pickers
  const colorAccent = document.getElementById("colorAccent");
  const colorAccent2 = document.getElementById("colorAccent2");
  const colorBg = document.getElementById("colorBg");
  const resetColorsBtn = document.getElementById("resetColorsBtn");

  // ====== Year ======
  const now = new Date();
  const YEAR = now.getFullYear();
  yearText.textContent = YEAR;

  // ====== Utils ======
  function showToast(msg){
    toastText.textContent = msg;
    toast.style.display = "inline-flex";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.style.display = "none", 1600);
  }

  function safeParseJSON(s){ try { return JSON.parse(s); } catch { return null; } }
  function save(state){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function load(){
    const raw = localStorage.getItem(LS_KEY);
    return raw ? safeParseJSON(raw) : null;
  }
  function normalizeQuestions(text){
    return uniqueQuestions(text.split("\n").map(s => s.trim()).filter(Boolean));
  }
  function esc(s){
    return (s ?? "").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    })[m]);
  }

  // ====== Theme Handling ======
  const DEFAULT_THEME = { accent:"#d12b2b", accent2:"#ff4a4a", bg:"#fff6f7" };

  function applyTheme(t){
    const theme = {
      accent: t?.accent ?? DEFAULT_THEME.accent,
      accent2: t?.accent2 ?? DEFAULT_THEME.accent2,
      bg: t?.bg ?? DEFAULT_THEME.bg
    };
    document.documentElement.style.setProperty("--accent", theme.accent);
    document.documentElement.style.setProperty("--accent2", theme.accent2);
    document.documentElement.style.setProperty("--bg", theme.bg);

    // inputs sync
    colorAccent.value = theme.accent;
    colorAccent2.value = theme.accent2;
    colorBg.value = theme.bg;

    localStorage.setItem(LS_THEME_KEY, JSON.stringify(theme));
    return theme;
  }

  function loadTheme(){
    const raw = localStorage.getItem(LS_THEME_KEY);
    const t = raw ? safeParseJSON(raw) : null;
    return applyTheme(t);
  }

  function getCurrentTheme(){
    const raw = localStorage.getItem(LS_THEME_KEY);
    const t = raw ? safeParseJSON(raw) : null;
    return {
      accent: t?.accent ?? DEFAULT_THEME.accent,
      accent2: t?.accent2 ?? DEFAULT_THEME.accent2,
      bg: t?.bg ?? DEFAULT_THEME.bg
    };
  }

  // ====== State ======
  let state = load() || {
    title: "ì˜¬í•´ì˜ ê²°ì‚° ë„ìš°ë¯¸",
    questions: uniqueQuestions(DEFAULT_QUESTIONS),
    idx: 0,
    answers: {},     // { [index]: string }
    skipped: {},     // { [index]: true }
    stoppedAt: null
  };

  // ====== Screen Transition ======
  function goAppScreen(){
    startScreen.classList.remove("visible");
    startScreen.classList.add("hidden");

    appScreen.classList.remove("hidden");
    appScreen.classList.add("visible");

    setTimeout(()=> answerEl?.focus(), 60);
  }

  // ====== Render ======
  function setPageTitle(){
    document.title = state.title;
    document.querySelector(".title").textContent = state.title;
  }

  function renderEditor(){
    customTitle.value = state.title;
    questionsEditor.value = state.questions.join("\n");
  }

  function doneCount(){
    return Object.keys(state.answers).length + Object.keys(state.skipped).length;
  }

  function renderProgress(){
    const total = state.questions.length;
    const done = doneCount();
    const pct = total ? Math.round((done / total) * 100) : 0;
    barFill.style.width = `${pct}%`;
    pctText.textContent = `${pct}% Â· ${done}/${total}`;
  }

  function isFinished(){ return state.idx >= state.questions.length; }

  function renderQuestion(){
    const total = state.questions.length;
    const finished = isFinished();

    if(finished){
      modeTitle.textContent = "ê²°ì‚° ë³´ê¸°";
      qNum.textContent = "DONE";
      qText.textContent = "ê²°ì‚°ì™„ë£Œ! ì˜¤ë¥¸ìª½ì—ì„œ ë‹µë³€ì„ í™•ì¸í•˜ê³ , ì›í•˜ëŠ” ì§ˆë¬¸ìœ¼ë¡œ ëŒì•„ê°€ ìˆ˜ì •í•  ìˆ˜ ìˆì–´.";
      answerEl.value = "";
      answerEl.disabled = true;
      nextBtn.disabled = true;
      stopBtn.disabled = true;
      return;
    }

    modeTitle.textContent = "ì§„í–‰";
    answerEl.disabled = false;
    nextBtn.disabled = false;
    stopBtn.disabled = false;

    qNum.textContent = `Q${state.idx + 1}/${total}`;
    qText.textContent = state.questions[state.idx];

    const existing = state.answers[state.idx] ?? "";
    answerEl.value = existing;
    setTimeout(() => answerEl.focus(), 0);
  }

  function renderSideList(){
    const total = state.questions.length;
    const rows = [];
    for(let i=0;i<total;i++){
      const q = state.questions[i];
      const a = state.answers[i];
      const isSkip = !!state.skipped[i] && (!a || a.trim()==="");
      const tag = a && a.trim() ? "ë‹µë³€" : (isSkip ? "íŒ¨ìŠ¤" : "ë¯¸ì‘ë‹µ");
      const ansHtml =
        (a && a.trim())
          ? `<p class="ans">${esc(a)}</p>`
          : `<p class="ans empty">${isSkip ? "íŒ¨ìŠ¤ ì²˜ë¦¬ë¨" : "ì•„ì§ ë‹µë³€ ì—†ìŒ"}</p>`;

      rows.push(`
        <div class="item">
          <div class="meta">
            <b>${esc(`Q${i+1}. ${q}`)}</b>
            <span class="tag">${esc(tag)}</span>
          </div>
          ${ansHtml}
          <div class="editlink" data-edit="${i}">âœï¸ ì´ ì§ˆë¬¸ ìˆ˜ì •í•˜ê¸°</div>
        </div>
      `);
    }
    sideList.innerHTML = rows.join("");

    sideList.querySelectorAll("[data-edit]").forEach(el => {
      el.addEventListener("click", () => {
        const i = Number(el.getAttribute("data-edit"));
        jumpToQuestion(i);
      });
    });

    const answeredCount = Object.keys(state.answers)
      .filter(k => (state.answers[k] ?? "").trim().length > 0).length;
    exportImageBtn.disabled = answeredCount === 0;
  }

  function renderAll(){
    setPageTitle();
    renderEditor();
    renderProgress();
    renderQuestion();
    renderSideList();
  }

  // ====== Actions ======
  function markCurrentAnswer(){
    const total = state.questions.length;
    if(state.idx >= total) return;

    const val = (answerEl.value ?? "").trimEnd();

    if(val.trim() === ""){
      delete state.answers[state.idx];
      state.skipped[state.idx] = true;
    }else{
      state.answers[state.idx] = val;
      delete state.skipped[state.idx];
    }
  }

  function next(){
    if(isFinished()) return;
    markCurrentAnswer();
    state.idx += 1;
    save(state);
    renderAll();
  }

  function stopAndShow(){
    if(isFinished()) return;
    state.stoppedAt = state.idx;
    markCurrentAnswer();
    state.idx = state.questions.length;
    save(state);
    renderAll();
    showToast("ê²°ì‚° í™”ë©´ìœ¼ë¡œ ì´ë™!");
  }

  function restart(){
    state.idx = 0;
    state.answers = {};
    state.skipped = {};
    state.stoppedAt = null;
    save(state);
    renderAll();
    showToast("ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘!");
  }

  function jumpToQuestion(i){
    state.idx = Math.max(0, Math.min(i, state.questions.length - 1));
    answerEl.disabled = false;
    nextBtn.disabled = false;
    stopBtn.disabled = false;
    save(state);
    renderAll();
    showToast(`Q${i+1}ë¡œ ì´ë™í•´ì„œ ìˆ˜ì • ì¤‘`);
  }

  function buildText({numbered=false, answeredOnly=false} = {}){
    const lines = [];
    const total = state.questions.length;

    for(let i=0;i<total;i++){
      const q = state.questions[i];
      const a = (state.answers[i] ?? "").trim();
      const isSkip = !!state.skipped[i] && !a;

      if(answeredOnly && !a) continue;

      if(numbered){
        lines.push(`${i+1}) ${q} - ${a ? a : (isSkip ? "(íŒ¨ìŠ¤)" : "(ë¯¸ì‘ë‹µ)")}`);
      }else{
        lines.push(`Q${i+1}. ${q}`);
        lines.push(`A${i+1}. ${a ? a : (isSkip ? "(íŒ¨ìŠ¤)" : "(ë¯¸ì‘ë‹µ)")}`);
        lines.push("");
      }
    }
    return lines.join("\n").trim() + "\n";
  }

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      showToast("ë³µì‚¬ ì™„ë£Œ!");
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      showToast("ë³µì‚¬ ì™„ë£Œ! (fallback)");
    }
  }

  // ====== Events ======
  startBtn.addEventListener("click", () => {
    save(state);
    renderAll();
    goAppScreen();
  });

  startResetBtn.addEventListener("click", () => {
    localStorage.removeItem(LS_KEY);
    state = {
      title: "ì˜¬í•´ì˜ ê²°ì‚° ë„ìš°ë¯¸",
      questions: uniqueQuestions(DEFAULT_QUESTIONS),
      idx: 0,
      answers: {},
      skipped: {},
      stoppedAt: null
    };
    renderAll();
    showToast("ì €ì¥ëœ ì§„í–‰ì„ ì´ˆê¸°í™”í–ˆì–´!");
  });

  nextBtn.addEventListener("click", next);
  stopBtn.addEventListener("click", stopAndShow);
  restartBtn.addEventListener("click", restart);

  copyNumberedBtn.addEventListener("click", () => copyToClipboard(buildText({numbered:true, answeredOnly:false})));
  copyAllBtn.addEventListener("click", () => copyToClipboard(buildText({numbered:false, answeredOnly:false})));
  copyAnsweredOnlyBtn.addEventListener("click", () => copyToClipboard(buildText({numbered:true, answeredOnly:true})));

  feedbackBtn.addEventListener("click", () => {
    if(!FEEDBACK_URL || FEEDBACK_URL.includes("example.com")){
      showToast("í”¼ë“œë°± ë§í¬ê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ì–´! (ì½”ë“œì˜ FEEDBACK_URL ìˆ˜ì •)");
      return;
    }
    window.open(FEEDBACK_URL, "_blank", "noopener,noreferrer");
  });

  answerEl.addEventListener("keydown", (e) => {
    if((e.ctrlKey || e.metaKey) && e.key === "Enter"){
      e.preventDefault();
      next();
    }
  });

  applyTitleBtn.addEventListener("click", () => {
    const t = (customTitle.value ?? "").trim();
    state.title = t.length ? t : "ì˜¬í•´ì˜ ê²°ì‚° ë„ìš°ë¯¸";
    save(state);
    renderAll();
    showToast("ì œëª© ì ìš© ì™„ë£Œ!");
  });

  applyQuestionsBtn.addEventListener("click", () => {
    const qs = normalizeQuestions(questionsEditor.value ?? "");
    if(qs.length < 1){
      showToast("ì§ˆë¬¸ì´ ìµœì†Œ 1ê°œëŠ” í•„ìš”í•´!");
      return;
    }
    state.questions = qs;
    state.idx = 0;
    state.answers = {};
    state.skipped = {};
    state.stoppedAt = null;
    save(state);
    renderAll();
    showToast("ì§ˆë¬¸ ì ìš© & ì´ˆê¸°í™” ì™„ë£Œ!");
  });

  resetQuestionsBtn.addEventListener("click", () => {
    questionsEditor.value = uniqueQuestions(DEFAULT_QUESTIONS).join("\n");
    showToast("ê¸°ë³¸ ì§ˆë¬¸(30ê°œ)ìœ¼ë¡œ ë³µì›!");
  });

  // ====== Theme events ======
  function onThemeChange(){
    const theme = {
      accent: colorAccent.value,
      accent2: colorAccent2.value,
      bg: colorBg.value
    };
    applyTheme(theme);
    showToast("ì»¬ëŸ¬ ì ìš©!");
  }
  colorAccent.addEventListener("input", onThemeChange);
  colorAccent2.addEventListener("input", onThemeChange);
  colorBg.addEventListener("input", onThemeChange);

  resetColorsBtn.addEventListener("click", () => {
    applyTheme(DEFAULT_THEME);
    showToast("ì»¬ëŸ¬ ì´ˆê¸°í™”!");
  });

  // =============================
  // ğŸ“¸ ì¸ìŠ¤íƒ€ ìŠ¤í† ë¦¬ ì¹´ë“œ (1080x1920 PNG)
  // âœ… í˜„ì¬ í…Œë§ˆ ì»¬ëŸ¬ë¥¼ ë°˜ì˜í•´ì„œ ìƒì„±
  // =============================
  exportImageBtn.addEventListener("click", generateInstagramStoryCard);

  function generateInstagramStoryCard(){
    const theme = getCurrentTheme();

    const W = 1080;
    const H = 1920;
    const PAD = 92;

    const answered = Object.keys(state.answers)
      .map(k => Number(k))
      .filter(i => (state.answers[i] ?? "").trim().length > 0)
      .map(i => ({ q: state.questions[i], a: String(state.answers[i]) }));

    if(answered.length === 0){
      showToast("ì•„ì§ ë‹µë³€ì´ ì—†ì–´! í•œ ê°œë¼ë„ ì‘ì„±í•´ì¤˜.");
      return;
    }

    shuffle(answered);

    const picks = answered.slice(0, Math.min(10, answered.length));

    const canvas = document.createElement("canvas");
    canvas.width = W;
    canvas.height = H;
    const ctx = canvas.getContext("2d");

    // ë°°ê²½ (ì‚¬ìš©ì bg ë°˜ì˜)
    ctx.fillStyle = theme.bg || "#fff6f7";
    ctx.fillRect(0, 0, W, H);

    // ê¸€ë¡œìš°: accent/accent2 ê¸°ë°˜
    radialGlow(ctx, W*0.2, H*0.18, 420, hexToRgba(theme.accent2, 0.22));
    radialGlow(ctx, W*0.85, H*0.78, 520, hexToRgba(theme.accent, 0.16));

    // ìŠ¤ë…¸ìš° ë„íŠ¸
    ctx.fillStyle = "rgba(255,255,255,0.95)";
    for(let i=0;i<120;i++){
      const x = Math.random() * W;
      const y = Math.random() * H;
      const r = 1.3 + Math.random()*2.4;
      ctx.beginPath();
      ctx.arc(x,y,r,0,Math.PI*2);
      ctx.fill();
    }

    // ë©”ì¸ ì¹´ë“œ
    const cardX = 54, cardY = 120, cardW = W-108, cardH = H-240;
    roundRect(ctx, cardX, cardY, cardW, cardH, 30);
    ctx.fillStyle = "rgba(255,255,255,0.88)";
    ctx.fill();
    ctx.strokeStyle = "rgba(0,0,0,0.10)";
    ctx.lineWidth = 2;
    ctx.stroke();

    // íƒ€ì´í‹€
    ctx.textAlign = "left";
    ctx.fillStyle = "#1b1b1b";
    ctx.font = "900 64px sans-serif";
    ctx.fillText(`${YEAR} ì˜¬í•´ì˜ ê²°ì‚°`, PAD, 230);

    ctx.font = "700 30px sans-serif";
    ctx.fillStyle = "rgba(0,0,0,0.55)";
    ctx.fillText(state.title, PAD, 285);

    // ë³¸ë¬¸
    let y = 370;
    const maxWidth = W - PAD*2;

    for(const {q, a} of picks){
      ctx.font = "900 34px sans-serif";
      ctx.fillStyle = theme.accent || "#d12b2b";
      y = wrapText(ctx, `â€¢ ${q}`, PAD, y, maxWidth, 44);

      ctx.font = "500 32px sans-serif";
      ctx.fillStyle = "#1b1b1b";
      y = wrapText(ctx, a, PAD + 18, y + 6, maxWidth - 18, 42);

      y += 18;
      if(y > H - 220) break;
    }

    // í•˜ë‹¨
    ctx.fillStyle = "rgba(0,0,0,0.55)";
    ctx.font = "700 26px sans-serif";
    ctx.fillText(`Â© ${YEAR}`, PAD, H - 130);

    ctx.textAlign = "right";
    ctx.fillText(`#ì—°ë§ê²°ì‚° #ì˜¬í•´ì˜`, W - PAD, H - 130);

    const link = document.createElement("a");
    link.download = `ì˜¬í•´ì˜_ê²°ì‚°_${YEAR}_story.png`;
    link.href = canvas.toDataURL("image/png");
    link.click();

    showToast("ìŠ¤í† ë¦¬ ì¹´ë“œ PNG ìƒì„±!");
  }

  function radialGlow(ctx, x, y, r, color){
    const g = ctx.createRadialGradient(x,y,0,x,y,r);
    g.addColorStop(0, color);
    g.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,ctx.canvas.width, ctx.canvas.height);
  }

  function shuffle(arr){
    for(let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  function wrapText(ctx, text, x, y, maxWidth, lineHeight){
    const hard = String(text).split("\n");
    for(const block of hard){
      const words = block.split(" ");
      let line = "";
      for(let n=0; n<words.length; n++){
        const testLine = line + words[n] + " ";
        const metrics = ctx.measureText(testLine);
        if(metrics.width > maxWidth && n > 0){
          ctx.fillText(line.trimEnd(), x, y);
          line = words[n] + " ";
          y += lineHeight;
        }else{
          line = testLine;
        }
      }
      ctx.fillText(line.trimEnd(), x, y);
      y += lineHeight;
    }
    return y;
  }

  function roundRect(ctx, x, y, w, h, r){
    r = Math.min(r, w/2, h/2);
    if (typeof ctx.roundRect === "function"){
      ctx.beginPath();
      ctx.roundRect(x, y, w, h, r);
      ctx.closePath();
      return;
    }
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
  }

  function hexToRgba(hex, a){
    const h = String(hex || "").replace("#","").trim();
    if(h.length !== 6) return `rgba(209,43,43,${a})`;
    const r = parseInt(h.slice(0,2), 16);
    const g = parseInt(h.slice(2,4), 16);
    const b = parseInt(h.slice(4,6), 16);
    return `rgba(${r},${g},${b},${a})`;
  }

  // ====== Init ======
  loadTheme();          // theme ë¨¼ì € ë°˜ì˜
  renderAll();
})();
</script>
</body>
</html>
